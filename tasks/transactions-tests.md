# Transactions and Transaction-Items Tests Implementation Task

## Objective
Create comprehensive contract tests for both transactions and transaction-items modules

## Current State Analysis

### Transactions Module

#### Schema (refs/db-models/transactions.sql)
- Fields: id, amount, order_id, payment_type_id, transaction_category_id, created_at, updated_at, uuid
- Required: amount, payment_type_id, transaction_category_id, uuid
- Has timestamps
- uuid is UNIQUE constraint

#### Model (refs/db-models/transactions.js)
- ✅ Fields match schema
- ✅ Has uuid auto-generation in $beforeInsert/$beforeUpdate
- ❌ **ISSUE**: Has invalid transactionTypes relation (no transaction_type_id field exists in schema)
- Relations: transactionItems (HasMany), orders (BelongsToOne), paymentTypes (BelongsToOne), transactionCategories (BelongsToOne)

#### TransactionEntity.js
- ✅ allowedColumns match schema
- ❌ **ISSUE**: Has transactionTypes relation (should be removed)
- ❌ **ISSUE**: Relation name mismatch - paymentType (singular) vs model's paymentTypes (plural)
- Relations: transactionItems, orders, paymentType, transactionCategories

### Transaction-Items Module

#### Schema (refs/db-models/transaction-items.sql)
- Fields: id, amount, transaction_id, transaction_type_id, payment_type_id, order_item_id, account_id, memo, commission_amount, created_at, updated_at
- Required: amount, transaction_id, transaction_type_id, payment_type_id, account_id
- Has timestamps

#### Model (refs/db-models/transaction-items.js)
- ✅ Fields match schema
- Relations: transaction (BelongsTo), orderItems (BelongsToOne), account (BelongsToOne), paymentType (BelongsToOne), transactionType (BelongsToOne)

#### TransactionItemEntity.js
- ✅ allowedColumns match schema
- ✅ Relations match model

## Implementation Plan

### Phase 1: Fix Model Issues (User will update DB package and refs)
- [ ] Remove transactionTypes relation from transactions model
- [ ] Fix relation name: paymentTypes → paymentType in transactions model
- [ ] Update TransactionEntity to remove transactionTypes relation
- [ ] Verify TransactionEntity relation names match updated model

### Phase 2: Transactions Module Tests
- [ ] Create seed.js for transactions
  - Needs: payment_type_id, transaction_category_id (from lookup tables)
  - Optional: order_id (can be null)
  - uuid will be auto-generated by model hook
  - Include timestamps

- [ ] Create entity.test.js
  - seedOne with amount, payment_type_id, transaction_category_id, timestamps
  - makeRelations: transactionItems, orders, paymentType, transactionCategories
  - updateOne for cloneWith test (update amount)

- [ ] Create repository.test.js
  - whereForUnique: if id exists return {id}, else return {uuid} (uuid is unique)
  - whereForExisting: {id}
  - Configure: supportsRelations: true, supportsFindAll, supportsPaginate, supportsExists

- [ ] Create service.test.js
  - Use initTransactionService from index.js
  - Same whereForUnique/whereForExisting as repository
  - Configure: supportsRelations: true, supportsSoftDelete: false, supportsActivation: false, supportsGetAll, skipGetActive

### Phase 3: Transaction-Items Module Tests
- [ ] Create seed.js for transaction-items
  - Needs: transaction_id, transaction_type_id, payment_type_id, account_id
  - Optional: order_item_id, memo, commission_amount
  - Include timestamps

- [ ] Create entity.test.js
  - seedOne with all required fields
  - makeRelations: transaction, orderItems, account, paymentType, transactionType
  - updateOne for cloneWith test (update amount or memo)

- [ ] Create repository.test.js
  - whereForUnique: {id} only (no obvious business key)
  - whereForExisting: {id}
  - Configure: supportsRelations: true, supportsFindAll, supportsPaginate, supportsExists

- [ ] Create service.test.js
  - Use initTransactionItemService from index.js
  - Same whereForUnique/whereForExisting as repository
  - Configure: supportsRelations: true, supportsSoftDelete: false, supportsActivation: false, supportsGetAll, skipGetActive

### Phase 4: Run Tests
- [ ] Run all transactions tests
- [ ] Run all transaction-items tests
- [ ] Fix any failures

### Phase 5: Commit and PR
- [ ] Commit to branch: claude/transactions-tests
- [ ] Wait for user approval before creating PR

## Dependencies and Relationships

**Transactions depends on:**
- payment-types (payment_type_id) ✅ Tests done
- transaction-categories (transaction_category_id) ✅ Tests done
- orders (order_id) - optional ✅ Tests done

**Transaction-Items depends on:**
- transactions (transaction_id) - will create in tests
- transaction-types (transaction_type_id) ✅ Tests done
- payment-types (payment_type_id) ✅ Tests done
- accounts (account_id) - need to check if tests exist
- order-items (order_item_id) - optional ✅ Tests done

## Questions to Resolve
1. ~~Does transactions table have transaction_type_id?~~ **NO - confirmed by user**
2. Should we test with actual related records or use IDs only? (Likely need actual records for FKs)
3. Are there accounts tests? Need to check.

## Expected Test Coverage
- Transactions: Entity (5 tests), Repository, Service (~26-29 tests total)
- Transaction-Items: Entity (5 tests), Repository, Service (~26-29 tests total)
- UUID auto-generation in transactions
- Relations tests for both modules

## Notes
- Transactions is a container for transaction-items
- Transaction-items have the credit/debit types, not transactions
- UUID is auto-generated in model hooks
- Both modules have timestamps
- Transaction-items has complex relationships (5 FK constraints)
