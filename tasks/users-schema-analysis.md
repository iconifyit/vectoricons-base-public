# Users Module Schema Analysis

## Schema Comparison

### Actual DB Table (DDL)
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email character varying(255) NOT NULL,
    username character varying(255) NOT NULL,
    first_name character varying(255),
    last_name character varying(255),
    password character varying(255),
    provider character varying(255) NOT NULL DEFAULT 'email'::character varying,
    reset_password_token character varying(255),
    reset_password_expires timestamp with time zone,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    is_deleted boolean DEFAULT false,
    display_name character varying(255) NOT NULL,
    image text,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    uuid uuid NOT NULL DEFAULT gen_random_uuid(),
    token_version integer NOT NULL DEFAULT 1
);
```

### @vectoricons.net/db Model
✅ **Status: MATCHES DB TABLE** (all 19 fields present)

### refs/db-models/users.js
✅ **Status: MATCHES DB TABLE** (all 19 fields present)

### src/users/UserEntity.js
✅ **Status: MATCHES DB TABLE** (all 19 fields in allowedColumns)

## Field Comparison Matrix

| Field | DB Table | DB Model | refs/db-models | UserEntity | Notes |
|-------|----------|----------|----------------|------------|-------|
| id | ✅ SERIAL | ✅ integer | ✅ integer | ✅ | Auto-increment |
| email | ✅ varchar(255) NOT NULL | ✅ string | ✅ string | ✅ | Required, indexed |
| username | ✅ varchar(255) NOT NULL | ✅ string | ✅ string | ✅ | Required, indexed, lowercase |
| display_name | ✅ varchar(255) NOT NULL | ✅ string | ✅ string | ✅ | Required |
| first_name | ✅ varchar(255) | ✅ string | ✅ string | ✅ | Optional, indexed |
| last_name | ✅ varchar(255) | ✅ string | ✅ string | ✅ | Optional, indexed |
| password | ✅ varchar(255) | ✅ string | ✅ string | ✅ | Optional, **hidden** |
| token_version | ✅ integer NOT NULL DEFAULT 1 | ✅ integer (default 1) | ✅ integer (default 1) | ✅ | For JWT invalidation |
| provider | ✅ varchar(255) NOT NULL DEFAULT 'email' | ✅ string (default 'email') | ✅ string (default 'email') | ✅ | Auth provider |
| reset_password_token | ✅ varchar(255) | ✅ string | ✅ string | ✅ | **hidden** |
| reset_password_expires | ✅ timestamp | ✅ string | ✅ string | ✅ | **hidden** |
| is_active | ✅ boolean DEFAULT true | ✅ boolean (default true) | ✅ boolean (default true) | ✅ | Account status |
| is_deleted | ✅ boolean DEFAULT false | ✅ boolean (default false) | ✅ boolean (default false) | ✅ | Soft delete flag, indexed |
| is_verified | ✅ boolean DEFAULT false | ✅ boolean (default false) | ✅ boolean (default false) | ✅ | Email verification |
| verified_at | ✅ timestamp | ✅ string | ✅ string | ✅ | Verification timestamp |
| image | ✅ text | ✅ string | ✅ string | ✅ | Profile image URL |
| uuid | ✅ uuid NOT NULL DEFAULT gen_random_uuid() | ✅ string | ✅ string | ✅ | Public identifier |
| created_at | ✅ timestamp DEFAULT CURRENT_TIMESTAMP | ✅ string | ✅ string | ✅ | Auto-set |
| updated_at | ✅ timestamp DEFAULT CURRENT_TIMESTAMP | ✅ string | ✅ string | ✅ | Auto-set |

## Constraints & Defaults

### NOT NULL Fields (Required)
- ✅ `email` - Must be provided
- ✅ `username` - Must be provided
- ✅ `display_name` - Must be provided
- ✅ `provider` - Defaults to 'email' if not provided
- ✅ `token_version` - Defaults to 1 if not provided
- ✅ `uuid` - Auto-generated by DB if not provided

### DEFAULT Values
- `provider` → `'email'`
- `is_active` → `true`
- `is_deleted` → `false`
- `is_verified` → `false`
- `token_version` → `1`
- `uuid` → `gen_random_uuid()` (DB function)
- `created_at` → `CURRENT_TIMESTAMP`
- `updated_at` → `CURRENT_TIMESTAMP`

### Indices
- ✅ Primary key on `id`
- ✅ Index on `email` (for lookups)
- ✅ Index on `username` (for lookups)
- ✅ Index on `first_name` (for search)
- ✅ Index on `last_name` (for search)
- ✅ Index on `is_deleted` (for filtering)

## Hidden Fields Configuration

UserEntity correctly hides sensitive fields from `toJSON()`:
- ✅ `password` - Never exposed
- ✅ `resetPasswordToken` (camelCase for `reset_password_token`) - Never exposed
- ✅ `resetPasswordExpires` (camelCase for `reset_password_expires`) - Never exposed

## Relations in UserEntity

| Relation | Type | Target Entity | Status |
|----------|------|---------------|--------|
| account | HasMany | AccountEntity | ✅ |
| roles | HasMany | UserRoleEntity | ✅ |
| userToRoles | HasMany | UserToRolesEntity | ✅ |
| favorites | HasMany | FavoriteEntity | ✅ |
| carts | HasMany | CartEntity | ✅ |
| orders | HasMany | OrderEntity | ✅ |
| credits | HasMany | CreditEntity | ✅ |
| invoices | HasMany | InvoiceEntity | ✅ |
| team | BelongsToOne | TeamEntity | ✅ |
| contributor | BelongsToOne | ContributorDetailEntity | ✅ |
| address | BelongsToOne | UserAddressEntity | ✅ |
| families | HasMany | FamilyEntity | ✅ |
| sets | HasMany | SetEntity | ✅ |
| social | HasMany | UserToSocialsEntity | ✅ |
| usersToEmail | HasMany | UserToEmailsEntity | ✅ |

**Note:** refs/db-models uses `icons` and `illustrations` relations, but UserEntity uses `families` and `sets` instead. This is intentional and correct.

## Model Hooks

### $beforeInsert
```javascript
$beforeInsert() {
    this.username = String(this.username).toLowerCase();

    // UUID is set by the DB, DO NOT SET IT HERE
    if (this.uuid) {
        delete this.uuid;
    }
}
```
- Username is auto-lowercased
- UUID is removed (DB generates it)

### $beforeUpdate
```javascript
$beforeUpdate() {
    if (this.username) {
        this.username = String(this.username).toLowerCase();
    }
}
```
- Username is auto-lowercased on updates

## Test Seed Data Requirements

### Minimal Valid User (Required Fields Only)
```javascript
{
    email: 'user@test.com',           // Required, unique
    username: 'testuser',             // Required, unique, will be lowercased
    display_name: 'Test User',        // Required
    provider: 'email',                // Will default if omitted
    token_version: 1,                 // Will default if omitted
    // uuid will be auto-generated by DB
}
```

### Full User (All Fields)
```javascript
{
    email: 'user@test.com',
    username: 'testuser',
    display_name: 'Test User',
    first_name: 'Test',
    last_name: 'User',
    password: '$2b$10$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36', // bcrypt hash
    provider: 'email',
    token_version: 1,
    reset_password_token: null,
    reset_password_expires: null,
    is_active: true,
    is_deleted: false,
    is_verified: false,
    verified_at: null,
    image: null,
    // uuid will be auto-generated by DB
}
```

## Validation Notes

### Email
- Must be unique in DB
- Commonly lowercased in application code
- Indexed for fast lookups

### Username
- Must be unique in DB
- Auto-lowercased by model hook
- Indexed for fast lookups

### UUID
- Auto-generated by DB using `gen_random_uuid()`
- Do NOT set in tests - let DB generate
- Used as public identifier (not exposing internal ID)

### Password
- Should be bcrypt hashed in real usage
- Can use dummy hash in tests: `$2b$10$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36`
- Never exposed in toJSON()

## Summary

✅ **All schemas are in sync** - No discrepancies found between:
- Actual DB table DDL
- @vectoricons.net/db model
- refs/db-models/users.js
- src/users/UserEntity.js

✅ **Hidden fields properly configured**
✅ **All 15 relations defined**
✅ **Model hooks working correctly** (username lowercasing, UUID handling)
✅ **Indices properly set up** for performance

**No schema updates needed** - Ready to proceed with test creation!
