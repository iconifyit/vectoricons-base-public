# Subscription Plans Tests

## Objective
Create comprehensive tests for the subscription-plans module following established SOA testing patterns.

## Plan

### 1. Branch Setup
- [x] Create new branch `claude/subscription-plans-tests`
- [x] Analyze SubscriptionPlan module structure
- [x] Write this task file

### 2. Test Structure
- [ ] Fix SubscriptionPlanEntity allowedColumns (camelCase)
- [ ] Add custom methods to SubscriptionPlanRepository (if needed)
- [ ] Add `withActivatable` mixin to SubscriptionPlanService
- [ ] Create comprehensive tests:
  - [ ] entity.test.js
  - [ ] repository.test.js (contract only)
  - [ ] repository.custom.test.js (if custom methods exist)
  - [ ] service.test.js

### 3. Module Analysis

**Entity Details:**
- **Entity**: SubscriptionPlanEntity
- **Fields** (14 total):
  - id (primary key)
  - title (text, NOT NULL)
  - description (text, nullable)
  - seats (integer, default 0)
  - price (numeric 10,2, default 0)
  - addons (integer, default 0)
  - monthly_downloads (integer, default 0)
  - billing_period (text, CHECK: 'monthly' or 'yearly')
  - is_active (boolean, default true)
  - stripe_price_id (varchar 255, NOT NULL)
  - stripe_lookup_key (varchar 255, nullable)
  - created_at (timestamp with time zone)
  - updated_at (timestamp with time zone)
  - group_name (varchar 64, nullable)
  - price_per_credit (numeric 10,2, GENERATED/COMPUTED - read-only)
- **Relations**: None (standalone entity)
- **Purpose**: Subscription plans with pricing, Stripe integration, and billing periods

**Repository:**
- **Repository**: SubscriptionPlanRepository (extends BaseRepository)
- **Model Name**: 'subscriptionPlans'
- **Custom Methods**: None currently (add if needed)
- **Required Fix**: None needed unless custom methods added

**Service:**
- **Service**: SubscriptionPlanService (extends BaseService)
- **Current Mixins**: None (just BaseService)
- **Dependencies**: None
- **Custom Methods**: None currently
- **Required Fix**: Add `withActivatable` mixin for is_active support

**Test Data Strategy:**
- Subscription plans with billing periods (monthly/yearly)
- Has activation (is_active)
- Has timestamps (created_at, updated_at)
- Has computed field (price_per_credit) - read-only, generated by DB
- Test billing_period validation ('monthly' or 'yearly')
- Test Stripe integration fields (stripe_price_id required)
- Test price calculations
- Test seats and addons
- Test activation/deactivation
- Test group_name (optional grouping)

**Contract Configuration:**
- `supportsSoftDelete: false` - No is_deleted field
- `supportsActivation: true` - Has is_active field
- `supportsTimestamps: true` - Has created_at/updated_at
- `whereForUnique: (data) => ({ title: data.title, billing_period: data.billing_period })` - Unique by title + billing_period
- `supportsRelations: false` - No relations

### 4. Test Coverage

**Entity Tests:**
- Field mapping for 14 fields (camelCase)
- Verify all fields present in toJSON output
- Standard contract tests
- Verify price_per_credit is computed (read-only)

**Repository Tests:**
- Standard CRUD operations via contract (repository.test.js)
- Verify correct model wiring (subscriptionPlans)
- Test timestamp behavior
- Test activation behavior

**Service Tests - Contract:**
- Standard service operations via contract
- Activation/deactivation tests
- Timestamp tests

**Service Tests - Custom (Subscription Plan Management):**

1. **Billing Period Validation:**
   - Test creating plans with 'monthly' billing_period
   - Test creating plans with 'yearly' billing_period
   - Test validation rejects invalid billing_period values

2. **Stripe Integration:**
   - Test creating plans with stripe_price_id (required)
   - Test creating plans with stripe_lookup_key (optional)
   - Test validation rejects missing stripe_price_id

3. **Price Calculations:**
   - Test price_per_credit computed for monthly plans
   - Test price_per_credit computed for yearly plans
   - Test price_per_credit with zero monthly_downloads (division by zero handling)

4. **Seats and Addons:**
   - Test creating plans with seats count
   - Test creating plans with addons count
   - Test defaults (seats=0, addons=0)

5. **Monthly Downloads:**
   - Test creating plans with monthly_downloads
   - Test default monthly_downloads=0
   - Test impact on price_per_credit calculation

6. **Group Name:**
   - Test creating plans with group_name (optional)
   - Test plans without group_name
   - Test finding plans by group_name

7. **Activation:**
   - Test plans are active by default (is_active=true)
   - Test deactivating plans
   - Test reactivating plans

### 5. Validation Rules
- **title**: Required, text
- **description**: Text, nullable
- **seats**: Integer, default 0
- **price**: Numeric (10,2), default 0
- **addons**: Integer, default 0
- **monthly_downloads**: Integer, default 0
- **billing_period**: Text, must be 'monthly' or 'yearly', required
- **is_active**: Boolean, defaults to true
- **stripe_price_id**: Varchar(255), required
- **stripe_lookup_key**: Varchar(255), nullable
- **group_name**: Varchar(64), nullable
- **price_per_credit**: Computed field (read-only, generated by DB)
- **Timestamps**: Automatically managed

### 6. Code Fixes Required
- [ ] Fix SubscriptionPlanEntity allowedColumns to use camelCase
- [ ] Add `withActivatable` mixin to SubscriptionPlanService
- [ ] Add custom methods if needed (e.g., findByBillingPeriod, findByGroupName, getActiveSubscriptionPlans)

### 7. Validation
- [ ] Run tests: `npm test -- src/products/subscriptions/subscription-plans/__tests__`
- [ ] All tests passing
- [ ] All service contract tests pass
- [ ] All custom service tests pass (if applicable)
- [ ] Entity tests: All passing
- [ ] Repository contract tests: All passing

### 8. Completion
- [ ] Tests complete - 100% pass rate
- [ ] Commit changes with proper message
- [ ] Create PR to develop branch

## Notes
- No relations (standalone entity)
- Has computed field price_per_credit (read-only, generated by DB)
- billing_period has CHECK constraint ('monthly' or 'yearly')
- Stripe integration via stripe_price_id (required) and stripe_lookup_key (optional)
- Has activation (is_active) but NO soft delete
- Use separate files if custom repository methods are added
- Price uses numeric(10,2) for precision
- Seats, addons, monthly_downloads are integers with defaults
- group_name allows grouping/categorizing plans
- price_per_credit calculation:
  - monthly: price / monthly_downloads
  - yearly: (price / 12) / monthly_downloads
  - Rounds to 2 decimals
  - Returns NULL if monthly_downloads is 0 (division by zero)
